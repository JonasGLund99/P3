@page "/"
@using src.Data
@using Microsoft.Azure.Cosmos

<PageTitle>Menu</PageTitle>

<main>
    <div id="experiments-container">
        <div id="experiment-header" class="menu-header">Experiments</div>
        <div class="toolbar">
            <button>+ Add</button>
            <input type="text" placeholder="Search...">
        </div>
        <div id="experiment-grid">
            <div class="grid-header">
                <span>Experiment number</span>
                <span>Author</span>
                <span>Title</span>
                <span>Created</span>
                <span>Edited</span>
            </div>
            @if (experiments == null) {
                <span>Loading...</span>
            } 
            else {
                foreach (Exp e in experiments) {
                    <div class="grid-content" @onclick="() => showClinicalTests(e)">
                        <span>@e.ExperimentNumber</span>
                        <span>@e.Author</span>
                        <span>@e.Title</span>
                    </div>
                }
            }
        </div>
    </div>
    <div id="clinical-test-container">
        <div id="clinical-test-header" class="menu-header">Clinical Tests</div>
        <div class="toolbar">
            <button>+ Add</button>
            <input type="text" placeholder="Search...">
        </div>
        <div id="clinical-test-grid">
            <div class="grid-header">
                <span>Title</span>
                <span>Created</span>
                <span>Edited</span>
            </div>
            @if (currentClinicalTests == null) {
                <span>Select an experiment</span>
            }
            else {
                foreach (CT ct in currentClinicalTests) {
                    <div class="grid-content">
                        <span>@ct.Title</span>
                    </div>
                }
            }
        </div>
    </div>
</main>


@code {

    private List<Exp>? experiments;
    private List<CT>? currentClinicalTests;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender) {
            experiments = new List<Exp>();
            if (DatabaseService.Instance.Database == null) throw new NullReferenceException("Database is null");
            FeedIterator<Exp> feed = DatabaseService.Instance.Database.GetContainer("Exp").GetItemQueryIterator<Exp>(
                queryDefinition: new QueryDefinition("SELECT * FROM Exp")
            );

            while(feed.HasMoreResults) {
                FeedResponse<Exp> response = await feed.ReadNextAsync();

                foreach(Exp item in response) {
                    experiments.Add(item);
                }
            }
            StateHasChanged();
        }
    }
    private async void showClinicalTests(Exp exp) {
        currentClinicalTests = new List<CT>();
        if (DatabaseService.Instance.Database == null) throw new NullReferenceException("Database is null");
        FeedIterator<CT> feed = DatabaseService.Instance.Database.GetContainer("CT").GetItemQueryIterator<CT>(
            queryDefinition: new QueryDefinition("SELECT * FROM ClinicalTest WHERE ARRAY_CONTAINS(ClinicalTest.ExperimentIds, @id)").WithParameter("@id", exp.id)
        );

        while(feed.HasMoreResults) {
            FeedResponse<CT> response = await feed.ReadNextAsync();

            foreach(CT item in response) {
                currentClinicalTests.Add(item);
            }
        }
        StateHasChanged();
    }
}
